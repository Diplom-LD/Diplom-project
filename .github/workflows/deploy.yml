name: Deploy with Docker Hub

on:
  push:
    branches:
      - main  

jobs:
  build_and_push:
    runs-on: ubuntu-latest

    steps:
      - name: üõéÔ∏è –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v3

      - name: ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π
        run: |
          set -e  # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –æ—à–∏–±–∫–µ

          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö..."
          
          # –£–±–∏—Ä–∞–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã –∏ –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫
          DOCKER_USER_CLEAN=$(echo "${{ secrets.DOCKER_USERNAME }}" | tr -d '[:space:]')

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ `DOCKER_USERNAME` –∑–∞–¥–∞–Ω
          if [[ -z "$DOCKER_USER_CLEAN" ]]; then
            echo "‚ùå –û—à–∏–±–∫–∞: DOCKER_USERNAME –Ω–µ –∑–∞–¥–∞–Ω –≤ GitHub Secrets –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–æ–±–µ–ª—ã!"
            exit 1
          fi

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ `DOCKER_PASSWORD` –∑–∞–¥–∞–Ω
          if [[ -z "${{ secrets.DOCKER_PASSWORD }}" ]]; then
            echo "‚ùå –û—à–∏–±–∫–∞: DOCKER_PASSWORD –Ω–µ –∑–∞–¥–∞–Ω –≤ GitHub Secrets!"
            exit 1
          fi

          echo "‚úÖ –í—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞–¥–∞–Ω—ã –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã!"
          echo "üîπ DOCKER_USERNAME: $DOCKER_USER_CLEAN (–±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤)"

      - name: üèóÔ∏è –õ–æ–≥–∏–Ω –≤ Docker Hub
        run: |
          echo "üîë –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ Docker Hub..."
          DOCKER_USER_CLEAN=$(echo "${{ secrets.DOCKER_USERNAME }}" | tr -d '[:space:]')
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "$DOCKER_USER_CLEAN" --password-stdin
          echo "‚úÖ –£—Å–ø–µ—à–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–ª–∏—Å—å –≤ Docker Hub!"

      - name: üìÇ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        run: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π —Å–µ—Ä–≤–∏—Å–æ–≤ –ø–µ—Ä–µ–¥ —Å–±–æ—Ä–∫–æ–π..."
          for SERVICE in AuthService OrderService BTUCalcService ManagerApp; do
            if [ ! -d "./$SERVICE" ]; then
              echo "‚ùå –û—à–∏–±–∫–∞: –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è $SERVICE –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"
              exit 1
            fi
          done
          echo "‚úÖ –í—Å–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –Ω–∞–π–¥–µ–Ω—ã!"
          echo "üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞:"
          ls -R

      - name: üì¶ –°–±–æ—Ä–∫–∞ –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –æ–±—Ä–∞–∑–æ–≤ –≤ Docker Hub
        run: |
          set -e  # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–µ

          # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–µ—Ä—Å–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–æ–º–µ—Ä–∞ —Å–±–æ—Ä–∫–∏ GitHub Actions
          VERSION="${{ github.run_number }}"  

          echo "üîπ –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤–µ—Ä—Å–∏—é: $VERSION"

          # –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–±–æ—Ä–∫–∏ –∏ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±—Ä–∞–∑–∞
          build_and_push() {
            local SERVICE_NAME=$1
            local SERVICE_PATH=$2

            echo "üöÄ –ù–∞—á–∞–ª–æ —Å–±–æ—Ä–∫–∏ –æ–±—Ä–∞–∑–∞: $SERVICE_NAME"
            if [ ! -f "$SERVICE_PATH/Dockerfile" ]; then
              echo "‚ùå –û—à–∏–±–∫–∞: –§–∞–π–ª Dockerfile –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ $SERVICE_PATH!"
              exit 1
            fi

            echo "üìÅ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª—ã –≤ $SERVICE_PATH –ø–µ—Ä–µ–¥ —Å–±–æ—Ä–∫–æ–π"
            ls -l "$SERVICE_PATH"

            echo "üõ†Ô∏è –ó–∞–ø—É—Å–∫–∞–µ–º —Å–±–æ—Ä–∫—É Docker-–æ–±—Ä–∞–∑–∞"
            docker build --no-cache -t "${{ secrets.DOCKER_USERNAME }}/$SERVICE_NAME:$VERSION" -f "$SERVICE_PATH/Dockerfile" .
            if [ $? -ne 0 ]; then
              echo "‚ùå –û—à–∏–±–∫–∞: –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞ $SERVICE_NAME –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å –Ω–µ—É–¥–∞—á–Ω–æ!"
              exit 1
            fi
            echo "‚úÖ –û–±—Ä–∞–∑ $SERVICE_NAME:$VERSION —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω"

            echo "üì§ –ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—Ä–∞–∑–∞ –≤ Docker Hub: $SERVICE_NAME:$VERSION"
            docker push "${{ secrets.DOCKER_USERNAME }}/$SERVICE_NAME:$VERSION"
            if [ $? -ne 0 ]; then
              echo "‚ùå –û—à–∏–±–∫–∞: –ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—Ä–∞–∑–∞ $SERVICE_NAME –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å –Ω–µ—É–¥–∞—á–Ω–æ!"
              exit 1
            fi
            echo "‚úÖ –û–±—Ä–∞–∑ $SERVICE_NAME:$VERSION –∑–∞–≥—Ä—É–∂–µ–Ω –≤ Docker Hub"

            echo "üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ latest-—Ç–µ–≥–∞ –¥–ª—è $SERVICE_NAME"
            docker tag "${{ secrets.DOCKER_USERNAME }}/$SERVICE_NAME:$VERSION" "${{ secrets.DOCKER_USERNAME }}/$SERVICE_NAME:latest"
            docker push "${{ secrets.DOCKER_USERNAME }}/$SERVICE_NAME:latest"
            if [ $? -ne 0 ]; then
              echo "‚ùå –û—à–∏–±–∫–∞: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ latest-—Ç–µ–≥–∞ $SERVICE_NAME –∑–∞–≤–µ—Ä—à–∏–ª–æ—Å—å –Ω–µ—É–¥–∞—á–Ω–æ!"
              exit 1
            fi
            echo "‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω latest-—Ç–µ–≥ –¥–ª—è $SERVICE_NAME"
          }

          # –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞
          build_and_push "auth-service" "AuthService"
          build_and_push "order-service" "OrderService"
          build_and_push "btu-calc-service" "BTUCalcService"
          build_and_push "manager-app" "ManagerApp"

      - name: ‚úÖ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ
        run: echo "üéâ –í—Å–µ –æ–±—Ä–∞–∑—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –≤ Docker Hub!"
